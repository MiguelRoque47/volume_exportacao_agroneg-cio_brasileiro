---
title: "Análise: Eficiência Produtiva vs. Retorno Financeiro"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```

## Tratamento dos dados

Antes das análises, faremos o tratamento e verificamos com os dados estão com um histograma e boxplot. 

### Resumo do que foi feito:
Os dados foram importados a partir de um arquivo Excel e tiveram seus nomes de variáveis padronizados com o pacote janitor. Em seguida, selecionaram-se apenas as variáveis relevantes (mês, código SH2, código NCM e valores anuais). As colunas referentes a diferentes anos, valores financeiros e quantidades físicas foram reorganizadas para o formato tidy com pivot_longer(), permitindo a identificação do ano e do tipo de medida (valor ou peso). Posteriormente, os dados foram agregados de forma consciente do nível NCM para o nível SH2, evitando duplicações. Por fim, os valores financeiros e físicos foram separados em colunas distintas e calculou-se o preço médio de exportação em dólares por tonelada.


```{r}
library(tidyverse)
library(here)
library(readxl)
library(janitor)

dados_brutos <- read_excel(here("data", "dados_exportacao.xlsx")) |> 
  clean_names() # clean names altera sinal de pontuação.
glimpse(dados_brutos)


dados <- dados_brutos |> 
  clean_names() |> 
  select(
    mes,
    codigo_sh2,
    codigo_ncm,   
    starts_with("x20")
  ) |> 
  pivot_longer(
    starts_with("x20"),
    names_to = "nome_sujo",
    values_to = "valor"
  ) |> 
  mutate(
    # str_sub(..., 2, 5) diz: "Comece na letra 2 e pare na 5".
    ano  = as.integer(str_sub(nome_sujo, 2, 5)), 
    tipo = case_when(
      str_detect(nome_sujo, "valor") ~ "dolar",
      str_detect(nome_sujo, "quilograma") ~ "peso"
    )
  ) |> 
  select(-nome_sujo) |> 
    group_by(mes, codigo_sh2, codigo_ncm, ano, tipo) |> 
  summarise(valor = sum(valor, na.rm = TRUE), .groups = "drop") |> 
    group_by(mes, codigo_sh2, ano, tipo) |> 
  summarise(valor = sum(valor, na.rm = TRUE), .groups = "drop") |> 
  
  pivot_wider(
    names_from = tipo,
    values_from = valor
  ) |> 
  
  mutate(
    preco_ton = if_else(
      !is.na(dolar) & peso > 0,
      (dolar / peso) * 1000,
      NA_real_
    ),
    codigo_sh2 = as.character(codigo_sh2),
    Produto = case_when(
      codigo_sh2 == "02" ~ "Carnes",
      codigo_sh2 == "09" ~ "Café",
      codigo_sh2 == "10" ~ "Cereais",
      codigo_sh2 == "12" ~ "Soja",
      codigo_sh2 == "17" ~ "Açúcar",
      TRUE ~ "Outros"
  )
  )
glimpse(dados)

ggplot(dados, aes(x = preco_ton))+
  geom_histogram(fill= "blue", color = "black")
ggplot(dados, aes(x= preco_ton))+
  geom_boxplot(fill="blue", color = "black")

ggplot(dados, aes(sample = preco_ton))+
  stat_qq()+
  stat_qq_line(color = "red")
```

## Tipo de distribuição

Iremos usar como Inferência mmodelos mistos, o que implica em manter normalidade nos dados. A seguir iremos chegar nessa normalidade (pois já podemos obserar nos gráficos acima que não seguem uma distribuição normal) e fazer as análises descritivas.

